import{w as y}from"./index.045fc982.js";import{a as w}from"./auth.1e7963e3.js";import{f as b}from"./scheduler.f21026e3.js";function p(){const{subscribe:l,set:v,update:s}=y({isInitialized:!1,isUnlocked:!1,isLoading:!1,error:null,collections:[]});let r=null;async function u(){s(e=>({...e,isLoading:!0,error:null}));try{if(!b(w).isAuthenticated)throw new Error("Not authenticated");const t=sessionStorage.getItem("volli_vault_key");t?(r=new Uint8Array(Buffer.from(t,"base64")),s(o=>({...o,isInitialized:!0,isUnlocked:!0,isLoading:!1,collections:["messages","contacts","files"]}))):s(o=>({...o,isInitialized:!0,isUnlocked:!1,isLoading:!1}))}catch(e){s(t=>({...t,isLoading:!1,error:e instanceof Error?e.message:"Failed to initialize vault"}))}}async function d(e){s(t=>({...t,isLoading:!0,error:null}));try{const o=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",o);r=new Uint8Array(a),sessionStorage.setItem("volli_vault_key",Buffer.from(r).toString("base64")),s(n=>({...n,isUnlocked:!0,isLoading:!1,collections:["messages","contacts","files"]}))}catch(t){s(o=>({...o,isLoading:!1,error:t instanceof Error?t.message:"Failed to unlock vault"}))}}async function f(){r=null,sessionStorage.removeItem("volli_vault_key"),s(e=>({...e,isUnlocked:!1,collections:[]}))}async function m(e,t){if(!r)throw new Error("Vault is locked");await(await c()).transaction(e,"readwrite").objectStore(e).put({id:t.id||crypto.randomUUID(),data:JSON.stringify(t),timestamp:Date.now()})}async function g(e,t){if(!r)throw new Error("Vault is locked");return(await(await c()).transaction(e,"readonly").objectStore(e).getAll()).map(i=>JSON.parse(i.data))}async function c(){return new Promise((e,t)=>{const o=indexedDB.open("volli_vault",1);o.onerror=()=>t(o.error),o.onsuccess=()=>e(o.result),o.onupgradeneeded=a=>{const n=a.target.result;["messages","contacts","files"].forEach(i=>{n.objectStoreNames.contains(i)||n.createObjectStore(i,{keyPath:"id"})})}})}return{subscribe:l,initialize:u,unlock:d,lock:f,store:m,query:g}}const U=p();export{U as v};
//# sourceMappingURL=vault.4a87f3ed.js.map
